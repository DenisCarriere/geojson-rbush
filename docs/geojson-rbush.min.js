!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.rbush=e()}(this,function(){function t(e,n,r){var i,o,a,h,s,l,u,f,c,m,p=0,d=0,g="FeatureCollection"===e.type,x="Feature"===e.type,y=g?e.features.length:1;for(i=0;y>i;i++)for(c=g?e.features[i].geometry:x?e.geometry:e,m="GeometryCollection"===c.type,u=m?c.geometries.length:1,h=0;u>h;h++)if(l=m?c.geometries[h]:c,f=l.coordinates,p=!r||"Polygon"!==l.type&&"MultiPolygon"!==l.type?0:1,"Point"===l.type)n(f,d),d++;else if("LineString"===l.type||"MultiPoint"===l.type)for(o=0;o<f.length;o++)n(f[o],d),d++;else if("Polygon"===l.type||"MultiLineString"===l.type)for(o=0;o<f.length;o++)for(a=0;a<f[o].length-p;a++)n(f[o][a],d),d++;else if("MultiPolygon"===l.type)for(o=0;o<f.length;o++)for(a=0;a<f[o].length;a++)for(s=0;s<f[o][a].length-p;s++)n(f[o][a][s],d),d++;else{if("GeometryCollection"!==l.type)throw new Error("Unknown Geometry Type");for(o=0;o<l.geometries.length;o++)t(l.geometries[o],n,r)}}function e(e,n,r,i){var o=r;return t(e,function(t,e){o=0===e&&void 0===r?t:n(o,t,e)},i),o}function n(t,e){var n;switch(t.type){case"FeatureCollection":for(n=0;n<t.features.length;n++)e(t.features[n].properties,n);break;case"Feature":e(t.properties,0)}}function r(t,e,r){var i=r;return n(t,function(t,n){i=0===n&&void 0===r?t:e(i,t,n)}),i}function i(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var n=0;n<t.features.length;n++)e(t.features[n],n)}function o(t,e,n){var r=n;return i(t,function(t,i){r=0===i&&void 0===n?t:e(r,t,i)}),r}function a(e){var n=[];return t(e,function(t){n.push(t)}),n}function h(t,e){var n,r,i,o,a,h,s,l=0,u="FeatureCollection"===t.type,f="Feature"===t.type,c=u?t.features.length:1;for(n=0;c>n;n++)for(h=u?t.features[n].geometry:f?t.geometry:t,s="GeometryCollection"===h.type,a=s?h.geometries.length:1,i=0;a>i;i++)if(o=s?h.geometries[i]:h,"Point"===o.type||"LineString"===o.type||"MultiPoint"===o.type||"Polygon"===o.type||"MultiLineString"===o.type||"MultiPolygon"===o.type)e(o,l),l++;else{if("GeometryCollection"!==o.type)throw new Error("Unknown Geometry Type");for(r=0;r<o.geometries.length;r++)e(o.geometries[r],l),l++}}function s(t,e,n){var r=n;return h(t,function(t,i){r=0===i&&void 0===n?t:e(r,t,i)}),r}function l(t,e){if(!t)throw new Error("No geometry passed");return{type:"Feature",properties:e||{},geometry:t}}function u(t,e,n,r,i){for(n=n||0,r=r||t.length-1,i=i||c;r>n;){if(r-n>600){var o=r-n+1,a=e-n+1,h=Math.log(o),s=.5*Math.exp(2*h/3),l=.5*Math.sqrt(h*s*(o-s)/o)*(0>a-o/2?-1:1),m=Math.max(n,Math.floor(e-a*s/o+l)),p=Math.min(r,Math.floor(e+(o-a)*s/o+l));u(t,e,m,p,i)}var d=t[e],g=n,x=r;for(f(t,n,e),i(t[r],d)>0&&f(t,n,r);x>g;){for(f(t,g,x),g++,x--;i(t[g],d)<0;)g++;for(;i(t[x],d)>0;)x--}0===i(t[n],d)?f(t,n,x):(x++,f(t,x,r)),e>=x&&(n=x+1),x>=e&&(r=x-1)}}function f(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function c(t,e){return e>t?-1:t>e?1:0}function m(t,e){return this instanceof m?(this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),void this.clear()):new m(t,e)}function p(t,e,n){if(!n)return e.indexOf(t);for(var r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function d(t,e){g(t,0,t.children.length,e,t)}function g(t,e,n,r,i){i||(i=b(null)),i.minX=1/0,i.minY=1/0,i.maxX=-(1/0),i.maxY=-(1/0);for(var o,a=e;n>a;a++)o=t.children[a],x(i,t.leaf?r(o):o);return i}function x(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function y(t,e){return t.minX-e.minX}function v(t,e){return t.minY-e.minY}function M(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function w(t){return t.maxX-t.minX+(t.maxY-t.minY)}function B(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function X(t,e){var n=Math.max(t.minX,e.minX),r=Math.max(t.minY,e.minY),i=Math.min(t.maxX,e.maxX),o=Math.min(t.maxY,e.maxY);return Math.max(0,i-n)*Math.max(0,o-r)}function Y(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function _(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function b(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-(1/0),maxY:-(1/0)}}function E(t,e,n,r,i){for(var o,a=[e,n];a.length;)n=a.pop(),e=a.pop(),r>=n-e||(o=e+Math.ceil((n-e)/r/2)*r,tt(t,o,e,n,i),a.push(e,o,o,n))}var P=t,S=e,C=n,F=r,N=i,k=o,R=a,L=h,O=s,G={coordEach:P,coordReduce:S,propEach:C,propReduce:F,featureEach:N,featureReduce:k,coordAll:R,geomEach:L,geomReduce:O},J=G.coordEach,j=function(t){var e=[1/0,1/0,-(1/0),-(1/0)];return J(t,function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])}),e},D=l,I=function(t,e){if(!t)throw new Error("No coordinates passed");if(void 0===t.length)throw new Error("Coordinates must be an array");if(t.length<2)throw new Error("Coordinates must be at least 2 numbers long");if("number"!=typeof t[0]||"number"!=typeof t[1])throw new Error("Coordinates must numbers");return l({type:"Point",coordinates:t},e)},T=function(t,e){if(!t)throw new Error("No coordinates passed");for(var n=0;n<t.length;n++){var r=t[n];if(r.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var i=0;i<r[r.length-1].length;i++)if(r[r.length-1][i]!==r[0][i])throw new Error("First and last Position are not equivalent.")}return l({type:"Polygon",coordinates:t},e)},q=function(t,e){if(!t)throw new Error("No coordinates passed");return l({type:"LineString",coordinates:t},e)},A=function(t){if(!t)throw new Error("No features passed");return{type:"FeatureCollection",features:t}},U=function(t,e){if(!t)throw new Error("No coordinates passed");return l({type:"MultiLineString",coordinates:t},e)},z=function(t,e){if(!t)throw new Error("No coordinates passed");return l({type:"MultiPoint",coordinates:t},e)},H=function(t,e){if(!t)throw new Error("No coordinates passed");return l({type:"MultiPolygon",coordinates:t},e)},K=function(t,e){if(!t)throw new Error("No geometries passed");return l({type:"GeometryCollection",geometries:t},e)},Q={miles:3960,nauticalmiles:3441.145,degrees:57.2957795,radians:1,inches:250905600,yards:6969600,meters:6373e3,metres:6373e3,kilometers:6373,kilometres:6373,feet:20908792.65},V=function(t,e){var n=Q[e||"kilometers"];if(void 0===n)throw new Error("Invalid unit");return t*n},W=function(t,e){var n=Q[e||"kilometers"];if(void 0===n)throw new Error("Invalid unit");return t/n},Z=function(t,e){var n=Q[e||"kilometers"];if(void 0===n)throw new Error("Invalid unit");return t/n*57.2958},$={feature:D,point:I,polygon:T,lineString:q,featureCollection:A,multiLineString:U,multiPoint:z,multiPolygon:H,geometryCollection:K,radiansToDistance:V,distanceToRadians:W,distanceToDegrees:Z},tt=u,et=m;m.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,n=[],r=this.toBBox;if(!_(t,e))return n;for(var i,o,a,h,s=[];e;){for(i=0,o=e.children.length;o>i;i++)a=e.children[i],h=e.leaf?r(a):a,_(t,h)&&(e.leaf?n.push(a):Y(t,h)?this._all(a,n):s.push(a));e=s.pop()}return n},collides:function(t){var e=this.data,n=this.toBBox;if(!_(t,e))return!1;for(var r,i,o,a,h=[];e;){for(r=0,i=e.children.length;i>r;r++)if(o=e.children[r],a=e.leaf?n(o):o,_(t,a)){if(e.leaf||Y(t,a))return!0;h.push(o)}e=h.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,n=t.length;n>e;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var i=this.data;this.data=r,r=i}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=b([]),this},remove:function(t,e){if(!t)return this;for(var n,r,i,o,a=this.data,h=this.toBBox(t),s=[],l=[];a||s.length;){if(a||(a=s.pop(),r=s[s.length-1],n=l.pop(),o=!0),a.leaf&&(i=p(t,a.children,e),-1!==i))return a.children.splice(i,1),s.push(a),this._condense(s),this;o||a.leaf||!Y(a,h)?r?(n++,a=r.children[n],o=!1):a=null:(s.push(a),l.push(n),n=0,r=a,a=a.children[0])}return this},toBBox:function(t){return t},compareMinX:y,compareMinY:v,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},_build:function(t,e,n,r){var i,o=n-e+1,a=this._maxEntries;if(a>=o)return i=b(t.slice(e,n+1)),d(i,this.toBBox),i;r||(r=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,r-1))),i=b([]),i.leaf=!1,i.height=r;var h,s,l,u,f=Math.ceil(o/a),c=f*Math.ceil(Math.sqrt(a));for(E(t,e,n,c,this.compareMinX),h=e;n>=h;h+=c)for(l=Math.min(h+c-1,n),E(t,h,l,f,this.compareMinY),s=h;l>=s;s+=f)u=Math.min(s+f-1,l),i.children.push(this._build(t,s,u,r-1));return d(i,this.toBBox),i},_chooseSubtree:function(t,e,n,r){for(var i,o,a,h,s,l,u,f;;){if(r.push(e),e.leaf||r.length-1===n)break;for(u=f=1/0,i=0,o=e.children.length;o>i;i++)a=e.children[i],s=M(a),l=B(t,a)-s,f>l?(f=l,u=u>s?s:u,h=a):l===f&&u>s&&(u=s,h=a);e=h||e.children[0]}return e},_insert:function(t,e,n){var r=this.toBBox,i=n?t:r(t),o=[],a=this._chooseSubtree(i,this.data,e,o);for(a.children.push(t),x(a,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)},_split:function(t,e){var n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);var o=this._chooseSplitIndex(n,i,r),a=b(n.children.splice(o,n.children.length-o));a.height=n.height,a.leaf=n.leaf,d(n,this.toBBox),d(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)},_splitRoot:function(t,e){this.data=b([t,e]),this.data.height=t.height+1,this.data.leaf=!1,d(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,n){var r,i,o,a,h,s,l,u;for(s=l=1/0,r=e;n-e>=r;r++)i=g(t,0,r,this.toBBox),o=g(t,r,n,this.toBBox),a=X(i,o),h=M(i)+M(o),s>a?(s=a,u=r,l=l>h?h:l):a===s&&l>h&&(l=h,u=r);return u},_chooseSplitAxis:function(t,e,n){var r=t.leaf?this.compareMinX:y,i=t.leaf?this.compareMinY:v,o=this._allDistMargin(t,e,n,r),a=this._allDistMargin(t,e,n,i);a>o&&t.children.sort(r)},_allDistMargin:function(t,e,n,r){t.children.sort(r);var i,o,a=this.toBBox,h=g(t,0,e,a),s=g(t,n-e,n,a),l=w(h)+w(s);for(i=e;n-e>i;i++)o=t.children[i],x(h,t.leaf?a(o):o),l+=w(h);for(i=n-e-1;i>=e;i--)o=t.children[i],x(s,t.leaf?a(o):o),l+=w(s);return l},_adjustParentBBoxes:function(t,e,n){for(var r=n;r>=0;r--)x(e[r],t)},_condense:function(t){for(var e,n=t.length-1;n>=0;n--)0===t[n].children.length?n>0?(e=t[n-1].children,e.splice(e.indexOf(t[n]),1)):this.clear():d(t[n],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};var nt=$.featureCollection,rt=G.featureEach,it=function(t){var e=et(t);return e.insert=function(t){return t.bbox=t.bbox?t.bbox:j(t),et.prototype.insert.call(this,t)},e.load=function(t){var e=[];return rt(t,function(t){t.bbox=t.bbox?t.bbox:j(t),e.push(t)}),et.prototype.load.call(this,e)},e.remove=function(t){return et.prototype.remove.call(this,t)},e.clear=function(){return et.prototype.clear.call(this)},e.search=function(t){var e=et.prototype.search.call(this,this.toBBox(t));return nt(e)},e.collides=function(t){return et.prototype.collides.call(this,this.toBBox(t))},e.all=function(){var t=et.prototype.all.call(this);return nt(t)},e.toJSON=function(){return et.prototype.toJSON.call(this)},e.fromJSON=function(t){return et.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var e=t.bbox?t.bbox:j(t);return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}},e};return it});